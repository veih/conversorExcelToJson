<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exibição de Dados do Excel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" id="searchButton" href="#">Exibição de Dados</a>
            <button class="navbar-toggler" id="infoButton" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Página Inicial</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#exampleModal" data-bs-toggle="modal"
                            data-bs-target="#exampleModal">Informações</a>
                    </li>
                </ul>
                <form class="d-flex">
                    <div class="d-flex mt-2" id="fileButton">
                        <input type="text" id="searchInput" placeholder="Digite para buscar"
                            class="form-control me-2 border border-primary">
                        <button type="button" id="searchButton" class="btn btn-primary">Buscar</button>
                    </div>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <pre id="jsonOutput"></pre>

        <div id="tableOutput" class="row row-cols-1 row-cols-md-3 g-4 mt-3"></div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Detalhes</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Conteúdo do seu modal aqui -->
                </div>
                <div class="modal-footer bg-primary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-warning" id="editButton">Editar</button>
                    <button type="button" class="btn btn-success d-none" id="saveChangesButton">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.1/dist/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileButton = document.getElementById('fileButton');
            const tableOutput = document.getElementById('tableOutput');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const modalTitle = document.querySelector('.modal-title');
            const modalBody = document.querySelector('.modal-body');
            const editButton = document.getElementById('editButton');
            const saveChangesButton = document.getElementById('saveChangesButton');

            let jsonData = []; // Variável global para armazenar os dados do Excel
            let currentCardIndex = null; // Índice do card atualmente aberto no modal
            let originalFileName = ''; // Variável para armazenar o nome do arquivo original

            // Função para buscar o arquivo Excel da API
            async function fetchExcelFile() {
                try {
                    const response = await fetch('/api/file/MANUTENÇAO_LOJAS_ATUALIZADA 0.1.xlsx');
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar o arquivo');
                    }
                    const data = await response.arrayBuffer();
                    const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    displayData(jsonData);
                } catch (error) {
                    console.error('Erro ao carregar o arquivo Excel:', error);
                }
            }

            // Evento de clique para o botão de busca
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Função para realizar a busca
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredData = jsonData.filter(row =>
                    row.some(cell => cell && cell.toString().toLowerCase().includes(searchTerm))
                );
                displayData([jsonData[0], ...filteredData]); // Mantém o cabeçalho e adiciona os dados filtrados
            }

            // Função para exibir os dados na tabela de cards
            function displayData(data) {
                tableOutput.innerHTML = ''; // Limpa a saída anterior
                const headers = data[0]; // Cabeçalhos da tabela

                data.slice(1).forEach((row, i) => {
                    const cardId = `card-${i + 1}`; // ID único para cada card
                    const cardHTML = `
                        <div class="col">
                            <div class="card bg-light shadow">
                                <div class="card-body">
                                    <h5 class="card-title">${row[0] !== undefined ? row[0] : ''}</h5>
                                    <p class="card-text">${row[1] !== undefined ? row[1] : ''}</p>
                                    <p class="card-text">${row[2] !== undefined ? row[2] : ''}</p>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-card-index="${i + 1}">
                                            Ver
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    tableOutput.insertAdjacentHTML('beforeend', cardHTML);
                });

                // Adicionar evento de clique dinâmico aos botões do card
                document.querySelectorAll('[data-card-index]').forEach(button => {
                    button.addEventListener('click', function () {
                        currentCardIndex = parseInt(button.getAttribute('data-card-index'), 10);
                        const cardData = data[currentCardIndex];
                        modalTitle.textContent = cardData[0];
                        modalBody.innerHTML = `
                            <div class="container mt-3">
                                <table class="table table-bordered">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Campo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${headers.map((header, index) => `
                                            <tr>
                                                <th>${header}</th>
                                                <td><input type="text" class="form-control border-0" value="${cardData[index] !== undefined ? cardData[index] : ''}" data-header-index="${index}" readonly></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                        editButton.classList.remove('d-none');
                        saveChangesButton.classList.add('d-none');
                    });
                });
            }

            // Evento de clique para o botão de editar no modal
            editButton.addEventListener('click', function () {
                modalBody.querySelectorAll('input[data-header-index]').forEach(input => {

                    input.removeAttribute('readonly');
                });
                editButton.classList.add('d-none');
                saveChangesButton.classList.remove('d-none');
            });

            // Evento de clique para o botão de salvar no modal
            saveChangesButton.addEventListener('click', async function () {
                const inputs = modalBody.querySelectorAll('input[data-header-index]');
                inputs.forEach(input => {
                    const index = input.getAttribute('data-header-index');
                    jsonData[currentCardIndex][index] = input.value;
                });

                // Re-exibir os dados atualizados
                displayData(jsonData);

                // Fechar o modal
                const modalElement = document.querySelector('#exampleModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();

                // Salvar a planilha atualizada no servidor
                const response = await fetch(`/api/file/${originalFileName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData),
                });

                if (!response.ok) {
                    console.error('Erro ao salvar o arquivo:', response.statusText);
                }
            });

            // Carregar o arquivo Excel automaticamente ao carregar a página
            fetchExcelFile();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>